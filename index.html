<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carpeta para MP3 (Web)</title>
  <style>
    body { font-family: system-ui, Arial; padding: 20px; max-width: 820px; margin: auto; }
    button { padding: 10px 14px; margin: 6px 6px 6px 0; cursor: pointer; }
    .box { padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-top: 10px; }
    .muted { color:#555; }
    ul { padding-left: 18px; }
    li { margin: 8px 0; }
    audio { width: 100%; margin-top: 8px; }
    code { background:#f6f6f6; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <h2>Tu carpeta de música MP3</h2>

  <div class="box">
    <p><b>Permiso de almacenamiento (modo web):</b> Para poder guardar y leer tus MP3, debes elegir una carpeta del dispositivo.
      Dentro de esa carpeta crearé <code>MiMusica</code> y ahí pondremos tus canciones.</p>

    <button id="btnPermiso">Dar permiso (elegir carpeta)</button>
    <button id="btnImportar" disabled>Importar MP3 a MiMusica</button>
    <button id="btnRefrescar" disabled>Ver mi música</button>

    <p id="status" class="muted">Estado: esperando…</p>
  </div>

  <div class="box">
    <h3>Lista de canciones</h3>
    <ul id="lista"></ul>
    <audio id="player" controls></audio>
  </div>

  <input id="filePicker" type="file" accept="audio/mpeg,audio/mp3" multiple style="display:none" />

  <script>
    const statusEl = document.getElementById("status");
    const listaEl = document.getElementById("lista");
    const player = document.getElementById("player");

    const btnPermiso = document.getElementById("btnPermiso");
    const btnImportar = document.getElementById("btnImportar");
    const btnRefrescar = document.getElementById("btnRefrescar");
    const filePicker = document.getElementById("filePicker");

    let rootDir = null;      // carpeta elegida por el usuario
    let musicaDir = null;    // subcarpeta MiMusica dentro de rootDir

    function setStatus(msg) { statusEl.textContent = "Estado: " + msg; }

    function soportaCarpetas() {
      return ("showDirectoryPicker" in window);
    }

    async function asegurarPermisoLecturaEscritura(handle) {
      // A veces se necesita pedir permiso explícito en algunos casos
      if (!handle) return false;
      if (handle.queryPermission) {
        let p = await handle.queryPermission({ mode: "readwrite" });
        if (p === "granted") return true;
        p = await handle.requestPermission({ mode: "readwrite" });
        return p === "granted";
      }
      return true;
    }

    btnPermiso.addEventListener("click", async () => {
      try {
        if (!soportaCarpetas()) {
          setStatus("Tu navegador NO soporta elegir carpeta. En iPhone Safari suele pasar. Usa una app Android o PWA especial.");
          return;
        }

        // El usuario elige carpeta => esto es lo más parecido a “dar permiso”
        rootDir = await window.showDirectoryPicker();

        const ok = await asegurarPermisoLecturaEscritura(rootDir);
        if (!ok) {
          rootDir = null;
          setStatus("No se concedió permiso de lectura/escritura.");
          return;
        }

        // Crear/abrir subcarpeta MiMusica
        musicaDir = await rootDir.getDirectoryHandle("MiMusica", { create: true });

        btnImportar.disabled = false;
        btnRefrescar.disabled = false;

        setStatus("Permiso concedido. Subcarpeta 'MiMusica' lista.");
        await refrescarLista();
      } catch (e) {
        rootDir = null;
        musicaDir = null;
        btnImportar.disabled = true;
        btnRefrescar.disabled = true;
        setStatus("Cancelado o error: " + (e?.message || e));
      }
    });

    btnImportar.addEventListener("click", () => {
      if (!musicaDir) { setStatus("Primero da permiso eligiendo una carpeta."); return; }
      filePicker.value = "";
      filePicker.click();
    });

    filePicker.addEventListener("change", async () => {
      try {
        const files = Array.from(filePicker.files || []);
        if (!files.length) return;

        setStatus("Importando " + files.length + " archivo(s)…");

        for (const f of files) {
          const nombre = f.name || ("cancion_" + Date.now() + ".mp3");

          // crear archivo en MiMusica
          const fileHandle = await musicaDir.getFileHandle(nombre, { create: true });
          const writable = await fileHandle.createWritable();

          // copiar bytes
          await writable.write(await f.arrayBuffer());
          await writable.close();
        }

        setStatus("Importación lista. Tus MP3 quedaron en MiMusica.");
        await refrescarLista();
      } catch (e) {
        setStatus("Error importando: " + (e?.message || e));
      }
    });

    btnRefrescar.addEventListener("click", refrescarLista);

    async function refrescarLista() {
      listaEl.innerHTML = "";
      player.removeAttribute("src");
      player.load();

      if (!musicaDir) {
        setStatus("Primero da permiso eligiendo una carpeta.");
        return;
      }

      let count = 0;

      // listar archivos dentro de MiMusica
      for await (const [name, handle] of musicaDir.entries()) {
        if (handle.kind !== "file") continue;
        if (!name.toLowerCase().endsWith(".mp3")) continue;

        count++;

        const li = document.createElement("li");
        const btn = document.createElement("button");
        btn.textContent = "▶ Reproducir";
        btn.addEventListener("click", async () => {
          const file = await handle.getFile();
          const url = URL.createObjectURL(file);
          player.src = url;
          player.play().catch(()=>{});
          setStatus("Reproduciendo: " + name);
        });

        li.textContent = name + " ";
        li.appendChild(btn);
        listaEl.appendChild(li);
      }

      setStatus(count ? ("Encontrados " + count + " MP3 en MiMusica.") : "No hay MP3 todavía. Usa 'Importar MP3'.");
    }
  </script>
</body>
</html>
